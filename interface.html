<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DeFi AI Agent â€” Transaction Diagnoser</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #050a0f;
      --surface:   #0b1520;
      --panel:     #0f1e2e;
      --border:    #1a3040;
      --accent:    #00e5ff;
      --accent2:   #ff4d6d;
      --accent3:   #7fff6f;
      --warn:      #ffb700;
      --text:      #c8dde8;
      --text-dim:  #4a6070;
      --font-mono: 'Space Mono', monospace;
      --font-head: 'Syne', sans-serif;
    }

    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.7;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ Grid Background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image:
        linear-gradient(rgba(0,229,255,.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,229,255,.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€ Scanline overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body::after {
      content: '';
      position: fixed; inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,.15) 2px,
        rgba(0,0,0,.15) 4px
      );
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wrapper { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 0 24px 80px; }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      padding: 40px 0 32px;
      display: flex; align-items: flex-start; gap: 20px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
    }

    .logo-glyph {
      width: 48px; height: 48px;
      border: 2px solid var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
      color: var(--accent);
      flex-shrink: 0;
      position: relative;
      animation: pulse-border 3s ease-in-out infinite;
    }
    .logo-glyph::before {
      content: '';
      position: absolute; inset: 3px;
      background: rgba(0,229,255,.06);
    }

    @keyframes pulse-border {
      0%,100% { box-shadow: 0 0 0 0 rgba(0,229,255,.4); }
      50%      { box-shadow: 0 0 0 8px rgba(0,229,255,0); }
    }

    .header-text h1 {
      font-family: var(--font-head);
      font-size: 26px;
      font-weight: 800;
      color: #fff;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }
    .header-text h1 span { color: var(--accent); }
    .header-text p {
      color: var(--text-dim);
      font-size: 12px;
      margin-top: 4px;
      letter-spacing: .5px;
    }

    .header-status {
      margin-left: auto;
      display: flex; align-items: center; gap: 8px;
      font-size: 11px;
      color: var(--text-dim);
      padding: 6px 12px;
      border: 1px solid var(--border);
      background: var(--surface);
    }
    .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--accent3);
      box-shadow: 0 0 6px var(--accent3);
      animation: blink 1.8s ease-in-out infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

    /* â”€â”€ Nav tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabs {
      display: flex; gap: 2px;
      margin-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }
    .tab-btn {
      background: none; border: none;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 10px 20px;
      cursor: pointer;
      position: relative;
      transition: color .2s;
    }
    .tab-btn.active { color: var(--accent); }
    .tab-btn.active::after {
      content: '';
      position: absolute; bottom: -1px; left: 0; right: 0;
      height: 2px; background: var(--accent);
    }
    .tab-btn:hover:not(.active) { color: var(--text); }

    /* â”€â”€ Tab panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; animation: fadein .25s ease; }
    @keyframes fadein { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

    /* â”€â”€ Form Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    @media(max-width:680px){ .grid-2,.grid-3{ grid-template-columns:1fr; } }

    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label {
      font-size: 10px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .field input,
    .field textarea,
    .field select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 12px;
      padding: 10px 12px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
      resize: vertical;
    }
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0,229,255,.12);
    }
    .field input::placeholder,
    .field textarea::placeholder { color: var(--text-dim); }
    .field select option { background: var(--surface); }

    /* â”€â”€ Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px 24px;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }
    .section-title::before {
      content: '';
      width: 16px; height: 1px;
      background: var(--accent);
    }

    /* â”€â”€ Error badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .error-pills {
      display: flex; flex-wrap: wrap; gap: 8px;
      margin-bottom: 20px;
    }
    .pill {
      padding: 5px 12px;
      border: 1px solid var(--border);
      font-size: 10px;
      letter-spacing: .5px;
      cursor: pointer;
      color: var(--text-dim);
      background: var(--surface);
      transition: all .2s;
      user-select: none;
    }
    .pill:hover, .pill.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0,229,255,.06);
    }

    /* â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-row { display: flex; gap: 12px; margin-top: 24px; align-items: center; }

    .btn {
      border: none; cursor: pointer;
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      padding: 12px 28px;
      transition: all .2s;
      position: relative;
      overflow: hidden;
    }
    .btn-primary {
      background: var(--accent);
      color: #000;
      font-weight: 700;
    }
    .btn-primary:hover { background: #33eeff; }
    .btn-primary:disabled { opacity: .4; cursor: not-allowed; }
    .btn-secondary {
      background: transparent;
      color: var(--text-dim);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { border-color: var(--text); color: var(--text); }

    .btn-primary .spinner {
      display: none;
      width: 12px; height: 12px;
      border: 2px solid rgba(0,0,0,.3);
      border-top-color: #000;
      border-radius: 50%;
      animation: spin .6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    .btn-primary.loading .spinner { display: inline-block; }
    .btn-primary.loading .btn-label { opacity: .7; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Result Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #results { margin-top: 32px; }

    .result-header {
      display: flex; align-items: center; gap: 12px;
      padding: 16px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom: none;
    }
    .result-badge {
      padding: 3px 10px;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-weight: 700;
    }
    .badge-gas      { background: rgba(255,183,0,.15);  color: var(--warn);   border: 1px solid var(--warn); }
    .badge-slippage { background: rgba(255,77,109,.15); color: var(--accent2);border: 1px solid var(--accent2); }
    .badge-allow    { background: rgba(0,229,255,.1);   color: var(--accent); border: 1px solid var(--accent); }
    .badge-balance  { background: rgba(255,77,109,.15); color: var(--accent2);border: 1px solid var(--accent2); }
    .badge-unknown  { background: rgba(74,96,112,.2);   color: var(--text);   border: 1px solid var(--border); }
    .badge-paused   { background: rgba(255,183,0,.15);  color: var(--warn);   border: 1px solid var(--warn); }
    .badge-access   { background: rgba(255,77,109,.15); color: var(--accent2);border: 1px solid var(--accent2); }
    .badge-ok       { background: rgba(127,255,111,.1); color: var(--accent3);border: 1px solid var(--accent3); }

    .result-hash { font-size: 11px; color: var(--text-dim); margin-left: auto; word-break: break-all; max-width: 260px; text-align: right; }

    .result-tabs {
      display: flex; gap: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom: none;
      border-top: none;
    }
    .result-tab {
      padding: 9px 18px;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      color: var(--text-dim);
      border: none; background: none;
      font-family: var(--font-mono);
      border-right: 1px solid var(--border);
      transition: color .2s, background .2s;
    }
    .result-tab.active { color: var(--accent); background: rgba(0,229,255,.06); }
    .result-tab:hover:not(.active) { color: var(--text); }

    .result-body {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 24px;
      min-height: 200px;
    }

    .result-section { display: none; }
    .result-section.active { display: block; animation: fadein .2s ease; }

    /* â”€â”€ Markdown-like output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ai-output { white-space: pre-wrap; font-size: 12.5px; line-height: 1.8; }
    .ai-output h2 { font-family: var(--font-head); color: #fff; font-size: 15px; margin: 16px 0 6px; }
    .ai-output h3 { color: var(--accent); font-size: 12px; letter-spacing: 1px; text-transform: uppercase; margin: 14px 0 4px; }
    .ai-output strong { color: #fff; }
    .ai-output em { color: var(--accent3); font-style: normal; }
    .ai-output code {
      background: rgba(0,229,255,.07);
      border: 1px solid rgba(0,229,255,.15);
      padding: 1px 6px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--accent);
    }
    .ai-output pre {
      background: #030810;
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      padding: 14px 16px;
      margin: 12px 0;
      overflow-x: auto;
      font-size: 11.5px;
      line-height: 1.6;
      color: #9fcfdf;
    }
    .ai-output pre code { background: none; border: none; padding: 0; color: inherit; font-size: inherit; }
    .ai-output ul, .ai-output ol { padding-left: 20px; margin: 8px 0; }
    .ai-output li { margin: 4px 0; }
    .ai-output hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
    .ai-output blockquote {
      border-left: 3px solid var(--accent2);
      padding: 8px 14px;
      margin: 10px 0;
      color: var(--text-dim);
      background: rgba(255,77,109,.05);
    }

    /* â”€â”€ Risk meter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .risk-indicator {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      background: var(--panel);
      margin-bottom: 20px;
    }
    .risk-label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim); }
    .risk-bar-wrap { flex: 1; height: 4px; background: var(--border); }
    .risk-bar { height: 100%; transition: width .6s ease, background .3s; }
    .risk-val { font-size: 11px; font-weight: 700; }

    /* â”€â”€ Loading skeleton â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .skeleton-wrap { display: none; }
    .skeleton-wrap.show { display: block; }
    .skeleton-line {
      height: 12px;
      background: linear-gradient(90deg, var(--border) 25%, var(--panel) 50%, var(--border) 75%);
      background-size: 400% 100%;
      animation: shimmer 1.4s infinite;
      margin-bottom: 10px;
    }
    .skeleton-line.w60 { width: 60%; }
    .skeleton-line.w80 { width: 80%; }
    .skeleton-line.w40 { width: 40%; }
    @keyframes shimmer { to { background-position: -400% 0; } }

    /* â”€â”€ Batch panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .batch-row {
      display: grid; grid-template-columns: auto 1fr auto auto;
      gap: 12px; align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
    }
    .batch-row:last-child { border-bottom: none; }
    .batch-index { color: var(--text-dim); width: 24px; text-align: right; }
    .batch-hash { color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .batch-cat { font-size: 10px; padding: 2px 8px; }
    .batch-remove {
      background: none; border: none; color: var(--text-dim);
      cursor: pointer; font-size: 16px; line-height: 1;
      transition: color .2s;
    }
    .batch-remove:hover { color: var(--accent2); }

    /* â”€â”€ Summary cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    @media(max-width:680px){ .summary-cards { grid-template-columns: 1fr 1fr; } }
    .scard {
      padding: 16px;
      background: var(--panel);
      border: 1px solid var(--border);
    }
    .scard-num { font-family: var(--font-head); font-size: 28px; font-weight: 800; color: #fff; line-height: 1; }
    .scard-label { font-size: 10px; color: var(--text-dim); margin-top: 4px; letter-spacing: 1px; text-transform: uppercase; }

    /* â”€â”€ API key input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .apikey-bar {
      display: flex; gap: 8px; align-items: center;
      padding: 12px 16px;
      background: rgba(0,229,255,.04);
      border: 1px solid rgba(0,229,255,.15);
      margin-bottom: 24px;
      font-size: 11px;
    }
    .apikey-bar label { color: var(--text-dim); letter-spacing: .5px; white-space: nowrap; }
    .apikey-bar input {
      flex: 1;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 11px;
      padding: 4px 6px;
      outline: none;
    }
    .apikey-bar input:focus { border-bottom-color: var(--accent); }
    .apikey-note { color: var(--text-dim); font-size: 10px; }

    /* â”€â”€ Notification toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 12px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      font-size: 12px;
      opacity: 0; transform: translateY(10px);
      transition: all .3s;
      z-index: 100;
      pointer-events: none;
    }
    #toast.show { opacity: 1; transform: none; }
    #toast.error { border-left-color: var(--accent2); }
  </style>
</head>
<body>
<div class="wrapper">

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header>
    <div class="logo-glyph">â¬¡</div>
    <div class="header-text">
      <h1>DeFi <span>AI</span> Agent</h1>
      <p>Transaction Failure Diagnosis Â· Powered by Claude</p>
    </div>
    <div class="header-status">
      <div class="dot"></div>
      <span>AGENT ONLINE</span>
    </div>
  </header>

  <!-- â”€â”€ API Key bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="apikey-bar">
    <label>ANTHROPIC_API_KEY</label>
    <input type="password" id="apiKey" placeholder="sk-ant-..." spellcheck="false" />
    <span class="apikey-note">Key is stored only in memory, never sent elsewhere.</span>
  </div>

  <!-- â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('diagnose',this)">// Diagnose</button>
    <button class="tab-btn" onclick="switchTab('batch',this)">// Batch</button>
    <button class="tab-btn" onclick="switchTab('docs',this)">// Docs</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: DIAGNOSE -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel active" id="tab-diagnose">

    <!-- Quick Demo Scenarios -->
    <div class="section">
      <div class="section-title">Quick Demo Scenarios</div>
      <div class="error-pills">
        <div class="pill" onclick="loadDemo('gas')">â›½ Out of Gas</div>
        <div class="pill" onclick="loadDemo('slippage')">ğŸ“‰ Slippage</div>
        <div class="pill" onclick="loadDemo('allowance')">ğŸ”’ Allowance</div>
        <div class="pill" onclick="loadDemo('paused')">â¸ Paused Contract</div>
        <div class="pill" onclick="loadDemo('access')">ğŸš« Access Control</div>
        <div class="pill" onclick="loadDemo('balance')">ğŸ’¸ Insufficient Balance</div>
      </div>
    </div>

    <!-- Transaction Form -->
    <form id="txForm" onsubmit="runDiagnosis(event)">

      <div class="section">
        <div class="section-title">Transaction Info</div>
        <div class="grid-2">
          <div class="field">
            <label>Transaction Hash</label>
            <input id="f-hash" type="text" placeholder="0x..." />
          </div>
          <div class="field">
            <label>Network</label>
            <select id="f-network">
              <option>Ethereum Mainnet</option>
              <option>Polygon</option>
              <option>Arbitrum</option>
              <option>Optimism</option>
              <option>BSC</option>
              <option>Avalanche</option>
              <option>Base</option>
            </select>
          </div>
          <div class="field">
            <label>From Address</label>
            <input id="f-from" type="text" placeholder="0x..." />
          </div>
          <div class="field">
            <label>To / Contract Address</label>
            <input id="f-to" type="text" placeholder="0x..." />
          </div>
          <div class="field">
            <label>Contract Name</label>
            <input id="f-contract" type="text" placeholder="e.g. Uniswap V3 Router" />
          </div>
          <div class="field">
            <label>Function Called</label>
            <input id="f-function" type="text" placeholder="e.g. swapExactTokensForETH" />
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Gas Info</div>
        <div class="grid-3">
          <div class="field">
            <label>Gas Used</label>
            <input id="f-gasUsed" type="text" placeholder="e.g. 21000" />
          </div>
          <div class="field">
            <label>Gas Limit</label>
            <input id="f-gasLimit" type="text" placeholder="e.g. 300000" />
          </div>
          <div class="field">
            <label>Gas Price</label>
            <input id="f-gasPrice" type="text" placeholder="e.g. 30 Gwei" />
          </div>
          <div class="field">
            <label>Value (ETH)</label>
            <input id="f-value" type="text" placeholder="e.g. 0.5" />
          </div>
          <div class="field">
            <label>Nonce</label>
            <input id="f-nonce" type="text" placeholder="e.g. 42" />
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Error Information</div>
        <div class="grid-2">
          <div class="field">
            <label>Raw Error Message *</label>
            <input id="f-error" type="text" placeholder="e.g. execution reverted" required />
          </div>
          <div class="field">
            <label>Revert Reason</label>
            <input id="f-revert" type="text" placeholder="e.g. ERC20: insufficient allowance" />
          </div>
        </div>
        <div class="field" style="margin-top:12px">
          <label>Input Data / Calldata</label>
          <input id="f-input" type="text" placeholder="0x18cbafe5..." />
        </div>
      </div>

      <div class="section">
        <div class="section-title">Additional Context (optional)</div>
        <div class="field">
          <label>Extra Context (JSON or plain text)</label>
          <textarea id="f-context" rows="4" placeholder='e.g. {"tokenIn": "USDC", "amountIn": "1000", "slippage": "0.5%"}'></textarea>
        </div>
      </div>

      <div class="btn-row">
        <button type="submit" class="btn btn-primary" id="diagnoseBtn">
          <span class="spinner"></span>
          <span class="btn-label">â–¶ Run Diagnosis</span>
        </button>
        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
        <span id="form-status" style="font-size:11px;color:var(--text-dim);margin-left:8px;"></span>
      </div>
    </form>

    <!-- Results -->
    <div id="results" style="display:none">
      <div class="result-header">
        <span style="font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;">Analysis Result</span>
        <span id="res-badge" class="result-badge badge-unknown">â€”</span>
        <span id="res-hash" class="result-hash"></span>
      </div>
      <div class="result-tabs">
        <button class="result-tab active" onclick="switchResTab('diagnosis',this)">Diagnosis</button>
        <button class="result-tab" onclick="switchResTab('fix',this)">Code Fix</button>
        <button class="result-tab" onclick="switchResTab('risk',this)">Risk</button>
        <button class="result-tab" onclick="switchResTab('raw',this)">Raw</button>
      </div>
      <div class="result-body">
        <!-- Skeleton -->
        <div class="skeleton-wrap" id="skeleton">
          <div class="skeleton-line w60"></div>
          <div class="skeleton-line w80"></div>
          <div class="skeleton-line w40"></div>
          <div class="skeleton-line w70" style="width:70%"></div>
          <div class="skeleton-line w80"></div>
        </div>

        <div class="result-section active" id="res-diagnosis"></div>
        <div class="result-section" id="res-fix"></div>
        <div class="result-section" id="res-risk">
          <div class="risk-indicator" id="riskMeter" style="display:none">
            <span class="risk-label">Risk Level</span>
            <div class="risk-bar-wrap"><div class="risk-bar" id="riskBarFill"></div></div>
            <span class="risk-val" id="riskVal">â€”</span>
          </div>
          <div id="res-risk-content"></div>
        </div>
        <div class="result-section" id="res-raw">
          <pre style="font-size:11px;overflow-x:auto;white-space:pre-wrap;color:var(--text-dim)"></pre>
        </div>
      </div>
    </div>
  </div><!-- end tab-diagnose -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: BATCH -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel" id="tab-batch">
    <div class="section">
      <div class="section-title">Add Transaction to Batch</div>
      <div class="grid-2">
        <div class="field">
          <label>Error Message *</label>
          <input id="b-error" type="text" placeholder="e.g. out of gas" />
        </div>
        <div class="field">
          <label>Revert Reason</label>
          <input id="b-revert" type="text" placeholder="e.g. ERC20: transfer amount exceeds allowance" />
        </div>
        <div class="field">
          <label>Contract</label>
          <input id="b-contract" type="text" placeholder="e.g. Aave V3" />
        </div>
        <div class="field">
          <label>Function</label>
          <input id="b-function" type="text" placeholder="e.g. supply" />
        </div>
      </div>
      <div class="btn-row">
        <button type="button" class="btn btn-secondary" onclick="addToBatch()">+ Add to Queue</button>
        <button type="button" class="btn btn-secondary" onclick="loadBatchDemo()">Load Demo (4 txs)</button>
      </div>
    </div>

    <div class="section" id="batchQueueSection" style="display:none">
      <div class="section-title">Queue <span id="batchCount" style="color:#fff">0</span> transactions</div>
      <div id="batchList"></div>
      <div class="btn-row" style="margin-top:16px">
        <button class="btn btn-primary" id="batchBtn" onclick="runBatch()">
          <span class="spinner"></span>
          <span class="btn-label">â–¶ Analyze All</span>
        </button>
        <button class="btn btn-secondary" onclick="clearBatch()">Clear Queue</button>
      </div>
    </div>

    <div id="batchResults" style="display:none">
      <div class="summary-cards" id="batchSummaryCards"></div>
      <div id="batchResultsList"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: DOCS -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel" id="tab-docs">
    <div class="section">
      <div class="section-title">How It Works</div>
      <div class="ai-output">
The DeFi AI Agent uses a <strong>3-turn multi-turn conversation</strong> with Claude to deeply analyze failed transactions.

<strong>Turn 1 â€” Diagnosis</strong>
Claude receives the full transaction context and identifies the root cause. It explains what happened in both technical and plain-English terms, then suggests initial fixes.

<strong>Turn 2 â€” Code Fix</strong>
Based on the diagnosis, Claude generates specific code snippets, parameter values, and a pre-flight retry checklist.

<strong>Turn 3 â€” Risk Assessment</strong>
Claude evaluates whether funds were lost, flags any security concerns, and rates its diagnostic confidence.
      </div>
    </div>

    <div class="section">
      <div class="section-title">Error Categories Supported</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div style="padding:12px;background:var(--surface);border:1px solid var(--border)">
          <div style="color:var(--warn);font-size:11px;font-weight:700;margin-bottom:4px">â›½ Gas Error</div>
          <div style="font-size:11px;color:var(--text-dim)">Gas limit too low for the operation. Common in complex DeFi interactions.</div>
        </div>
        <div style="padding:12px;background:var(--surface);border:1px solid var(--border)">
          <div style="color:var(--accent2);font-size:11px;font-weight:700;margin-bottom:4px">ğŸ“‰ Slippage Error</div>
          <div style="font-size:11px;color:var(--text-dim)">Price moved beyond tolerance. High impact trades on low-liquidity pools.</div>
        </div>
        <div style="padding:12px;background:var(--surface);border:1px solid var(--border)">
          <div style="color:var(--accent);font-size:11px;font-weight:700;margin-bottom:4px">ğŸ”’ Allowance Error</div>
          <div style="font-size:11px;color:var(--text-dim)">Token not approved for the contract to spend. Requires approve() call first.</div>
        </div>
        <div style="padding:12px;background:var(--surface);border:1px solid var(--border)">
          <div style="color:var(--accent2);font-size:11px;font-weight:700;margin-bottom:4px">ğŸ’¸ Balance Error</div>
          <div style="font-size:11px;color:var(--text-dim)">Insufficient token or ETH balance to complete the transaction.</div>
        </div>
        <div style="padding:12px;background:var(--surface);border:1px solid var(--border)">
          <div style="color:var(--warn);font-size:11px;font-weight:700;margin-bottom:4px">â¸ Contract Paused</div>
          <div style="font-size:11px;color:var(--text-dim)">Protocol is in emergency pause mode. Wait for governance to resume.</div>
        </div>
        <div style="padding:12px;background:var(--surface);border:1px solid var(--border)">
          <div style="color:var(--accent2);font-size:11px;font-weight:700;margin-bottom:4px">ğŸš« Access Control</div>
          <div style="font-size:11px;color:var(--text-dim)">Caller is not authorized (not owner/admin) to call this function.</div>
        </div>
        <div style="padding:12px;background:var(--surface);border:1px solid var(--border)">
          <div style="color:var(--warn);font-size:11px;font-weight:700;margin-bottom:4px">â° Deadline Error</div>
          <div style="font-size:11px;color:var(--text-dim)">Transaction submitted too late; deadline timestamp expired.</div>
        </div>
        <div style="padding:12px;background:var(--surface);border:1px solid var(--border)">
          <div style="color:var(--text);font-size:11px;font-weight:700;margin-bottom:4px">ğŸ”„ Reentrancy Guard</div>
          <div style="font-size:11px;color:var(--text-dim)">Contract blocked a recursive call (security protection).</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">API Reference (Backend)</div>
      <pre style="font-size:11px;color:#9fcfdf;line-height:1.8">
POST /diagnose      â€” Full AI analysis (3-turn Claude conversation)
POST /classify      â€” Instant pattern-matching (no AI, &lt;1ms)
POST /batch         â€” Analyze up to 10 transactions at once
GET  /health        â€” Server health check

<strong style="color:var(--accent)">// Example Request</strong>
fetch('http://localhost:3000/diagnose', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    hash: '0xabc...',
    error: 'execution reverted',
    revertReason: 'ERC20: insufficient allowance',
    contractName: 'Uniswap V2',
    gasUsed: '45000',
    gasLimit: '300000'
  })
})
      </pre>
    </div>
  </div><!-- end tab-docs -->

</div><!-- .wrapper -->

<!-- Toast -->
<div id="toast"></div>

<script>
// â”€â”€ Demo data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMOS = {
  gas: {
    hash: '0x1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b',
    network: 'Ethereum Mainnet',
    from: '0xUserWallet123abc',
    to: '0xUniswapV2Router02',
    contract: 'Uniswap V2 Router',
    function: 'swapExactTokensForETH',
    gasUsed: '21000', gasLimit: '21000', gasPrice: '30 Gwei',
    value: '0', nonce: '42',
    error: 'out of gas',
    revert: 'Transaction ran out of gas',
    input: '0x18cbafe5....',
    context: '{"tokenIn":"USDC","tokenOut":"ETH","amountIn":"1000 USDC","estimatedGas":"150000","actualGasLimit":"21000"}'
  },
  slippage: {
    hash: '0x9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e',
    network: 'Ethereum Mainnet',
    from: '0xTrader456def',
    to: '0xUniswapV3Router',
    contract: 'Uniswap V3 Router',
    function: 'exactInputSingle',
    gasUsed: '98543', gasLimit: '200000', gasPrice: '25 Gwei',
    value: '1.5', nonce: '7',
    error: 'execution reverted',
    revert: 'Too little received',
    input: '0x04e45aaf....',
    context: '{"tokenIn":"ETH","tokenOut":"PEPE","amountIn":"1.5 ETH","slippageTolerance":"0.1%","priceImpact":"8.5%","poolLiquidity":"Low"}'
  },
  allowance: {
    hash: '0x3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d',
    network: 'Polygon',
    from: '0xDeFiUser789ghi',
    to: '0xAaveV3Pool',
    contract: 'Aave V3 Lending Pool',
    function: 'supply',
    gasUsed: '45231', gasLimit: '300000', gasPrice: '100 Gwei',
    value: '0', nonce: '156',
    error: 'execution reverted',
    revert: 'ERC20: transfer amount exceeds allowance',
    input: '0x617ba037....',
    context: '{"token":"USDT","attemptedAmount":"5000 USDT","currentAllowance":"0 USDT","spender":"Aave V3 Pool"}'
  },
  paused: {
    hash: '0x7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c',
    network: 'Arbitrum',
    from: '0xYieldFarmer321jkl',
    to: '0xCompoundProtocol',
    contract: 'Compound Finance',
    function: 'mint',
    gasUsed: '31000', gasLimit: '250000', gasPrice: '0.1 Gwei',
    value: '0', nonce: '89',
    error: 'execution reverted',
    revert: 'Pausable: paused',
    input: '0xa0712d68....',
    context: '{"reason":"Emergency pause triggered due to oracle manipulation","pausedAt":"2024-01-15T16:40:00Z"}'
  },
  access: {
    hash: '0x4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f',
    network: 'Ethereum Mainnet',
    from: '0xRandomUser999',
    to: '0xVaultAdmin',
    contract: 'Yearn Vault',
    function: 'setEmergencyShutdown',
    gasUsed: '22000', gasLimit: '100000', gasPrice: '20 Gwei',
    value: '0', nonce: '3',
    error: 'execution reverted',
    revert: 'Ownable: caller is not the owner',
    input: '0x....',
    context: '{"caller":"0xRandomUser999","owner":"0xYearnGovernance","action":"Emergency shutdown"}'
  },
  balance: {
    hash: '0xb1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2',
    network: 'BSC',
    from: '0xWhale123',
    to: '0xPancakeSwap',
    contract: 'PancakeSwap Router',
    function: 'swapExactTokensForTokens',
    gasUsed: '0', gasLimit: '250000', gasPrice: '5 Gwei',
    value: '0', nonce: '201',
    error: 'execution reverted',
    revert: 'BEP20: transfer amount exceeds balance',
    input: '0x38ed1739....',
    context: '{"tokenIn":"CAKE","attemptedAmount":"50000 CAKE","walletBalance":"1200 CAKE"}'
  }
};

// â”€â”€ Batch queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let batchQueue = [];

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, el) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

function switchResTab(name, el) {
  document.querySelectorAll('.result-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.result-section').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('res-' + name).classList.add('active');
}

// â”€â”€ Load demo data into form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDemo(key) {
  const d = DEMOS[key];
  if (!d) return;
  document.getElementById('f-hash').value      = d.hash;
  document.getElementById('f-network').value   = d.network;
  document.getElementById('f-from').value      = d.from;
  document.getElementById('f-to').value        = d.to;
  document.getElementById('f-contract').value  = d.contract;
  document.getElementById('f-function').value  = d.function;
  document.getElementById('f-gasUsed').value   = d.gasUsed;
  document.getElementById('f-gasLimit').value  = d.gasLimit;
  document.getElementById('f-gasPrice').value  = d.gasPrice;
  document.getElementById('f-value').value     = d.value;
  document.getElementById('f-nonce').value     = d.nonce;
  document.getElementById('f-error').value     = d.error;
  document.getElementById('f-revert').value    = d.revert;
  document.getElementById('f-input').value     = d.input;
  document.getElementById('f-context').value   = d.context;
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  showToast('Demo loaded: ' + event.target.textContent.trim());
}

function clearForm() {
  document.getElementById('txForm').reset();
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  document.getElementById('results').style.display = 'none';
}

// â”€â”€ Markdown renderer (minimal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkdown(text) {
  let html = text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/```(\w*)\n([\s\S]*?)```/g, (_,lang,code) =>
      `<pre><code>${code}</code></pre>`)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>')
    .replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>')
    .replace(/^#{1}\s+(.+)$/gm, '<h2>$1</h2>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^---$/gm, '<hr>')
    .replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>')
    .replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>');
  // Wrap consecutive <li> in <ul>
  html = html.replace(/(<li>[\s\S]*?<\/li>\n?)+/g, m => `<ul>${m}</ul>`);
  return html;
}

// â”€â”€ Risk level from text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractRisk(text) {
  const t = text.toLowerCase();
  if (t.includes('critical') || t.includes('funds lost') || t.includes('high risk')) return {level:'Critical',pct:95,color:'#ff4d6d'};
  if (t.includes('high')) return {level:'High',pct:70,color:'#ffb700'};
  if (t.includes('medium') || t.includes('moderate')) return {level:'Medium',pct:45,color:'#ffb700'};
  return {level:'Low',pct:20,color:'#7fff6f'};
}

function getBadgeClass(category) {
  const c = (category||'').toLowerCase();
  if (c.includes('gas')) return ['badge-gas','â›½ GAS ERROR'];
  if (c.includes('slippage')) return ['badge-slippage','ğŸ“‰ SLIPPAGE'];
  if (c.includes('allowance')) return ['badge-allow','ğŸ”’ ALLOWANCE'];
  if (c.includes('balance')) return ['badge-balance','ğŸ’¸ BALANCE'];
  if (c.includes('paused')) return ['badge-paused','â¸ PAUSED'];
  if (c.includes('access')) return ['badge-access','ğŸš« ACCESS'];
  return ['badge-unknown','âš  UNKNOWN'];
}

// â”€â”€ Quick local classification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classifyLocally(error, revert) {
  const s = (error + ' ' + revert).toLowerCase();
  if (s.includes('out of gas') || s.includes('gas required')) return 'Gas Error';
  if (s.includes('insufficient output') || s.includes('too little received') || s.includes('slippage') || s.includes('k')) return 'Slippage Error';
  if (s.includes('allowance') || s.includes('approve')) return 'Allowance Error';
  if (s.includes('balance') || s.includes('exceeds balance')) return 'Balance Error';
  if (s.includes('paused')) return 'Contract Paused';
  if (s.includes('not the owner') || s.includes('not authorized') || s.includes('onlyowner')) return 'Access Control Error';
  if (s.includes('deadline') || s.includes('expired')) return 'Deadline Error';
  return 'Execution Revert';
}

// â”€â”€ Main diagnosis via Claude API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runDiagnosis(e) {
  e.preventDefault();

  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { showToast('Please enter your Anthropic API key', true); return; }

  const error = document.getElementById('f-error').value.trim();
  if (!error) { showToast('Error message is required', true); return; }

  // Build tx object
  const tx = {
    hash:         document.getElementById('f-hash').value.trim() || 'N/A',
    network:      document.getElementById('f-network').value,
    from:         document.getElementById('f-from').value.trim(),
    to:           document.getElementById('f-to').value.trim(),
    contractName: document.getElementById('f-contract').value.trim() || 'Unknown Contract',
    functionName: document.getElementById('f-function').value.trim() || 'Unknown Function',
    gasUsed:      document.getElementById('f-gasUsed').value.trim(),
    gasLimit:     document.getElementById('f-gasLimit').value.trim(),
    gasPrice:     document.getElementById('f-gasPrice').value.trim(),
    value:        document.getElementById('f-value').value.trim(),
    nonce:        document.getElementById('f-nonce').value.trim(),
    error,
    revertReason: document.getElementById('f-revert').value.trim(),
    inputData:    document.getElementById('f-input').value.trim(),
  };

  let ctx = {};
  try { ctx = JSON.parse(document.getElementById('f-context').value || '{}'); }
  catch { ctx = { note: document.getElementById('f-context').value }; }
  tx.additionalContext = ctx;

  // UI loading state
  const btn = document.getElementById('diagnoseBtn');
  btn.disabled = true; btn.classList.add('loading');
  document.getElementById('form-status').textContent = 'Contacting Claude AIâ€¦';

  document.getElementById('results').style.display = 'block';
  document.getElementById('skeleton').classList.add('show');
  document.querySelectorAll('.result-section').forEach(s => { s.classList.remove('active'); s.innerHTML = ''; });
  document.getElementById('res-diagnosis').classList.add('active');

  // Badge + hash preview
  const localCat = classifyLocally(tx.error, tx.revertReason);
  const [bClass, bLabel] = getBadgeClass(localCat);
  const badge = document.getElementById('res-badge');
  badge.className = 'result-badge ' + bClass;
  badge.textContent = bLabel;
  document.getElementById('res-hash').textContent = tx.hash.length > 30 ? tx.hash.slice(0,18)+'â€¦'+tx.hash.slice(-6) : tx.hash;

  try {
    const result = await diagnoseWithClaude(tx, apiKey);

    document.getElementById('skeleton').classList.remove('show');
    document.getElementById('form-status').textContent = 'âœ“ Analysis complete';

    // Diagnosis tab
    const diagEl = document.getElementById('res-diagnosis');
    diagEl.className = 'result-section active ai-output';
    diagEl.innerHTML = renderMarkdown(result.diagnosis);

    // Fix tab
    const fixEl = document.getElementById('res-fix');
    fixEl.className = 'result-section ai-output';
    fixEl.innerHTML = renderMarkdown(result.codeFix);

    // Risk tab
    const riskEl = document.getElementById('res-risk-content');
    riskEl.className = 'ai-output';
    riskEl.innerHTML = renderMarkdown(result.riskAssessment);
    const risk = extractRisk(result.riskAssessment);
    const meter = document.getElementById('riskMeter');
    meter.style.display = 'flex';
    document.getElementById('riskBarFill').style.cssText = `width:${risk.pct}%;background:${risk.color}`;
    document.getElementById('riskVal').style.color = risk.color;
    document.getElementById('riskVal').textContent = risk.level;

    // Raw tab
    const rawPre = document.querySelector('#res-raw pre');
    rawPre.textContent = JSON.stringify({ tx, ...result }, null, 2);

    showToast('âœ“ Diagnosis complete');
  } catch(err) {
    document.getElementById('skeleton').classList.remove('show');
    document.getElementById('form-status').textContent = '';
    const diagEl = document.getElementById('res-diagnosis');
    diagEl.className = 'result-section active ai-output';
    diagEl.innerHTML = `<div style="color:var(--accent2);padding:12px;border:1px solid var(--accent2);background:rgba(255,77,109,.08)">${err.message}</div>`;
    showToast('Error: ' + err.message, true);
  }

  btn.disabled = false; btn.classList.remove('loading');
}

// â”€â”€ Claude API call (multi-turn) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function diagnoseWithClaude(tx, apiKey) {
  const system = `You are an expert DeFi transaction failure analyst. Analyze failed blockchain transaction data and provide:
- Root Cause (1 sentence)
- Detailed Explanation (2-3 sentences, technical)
- User-Friendly Explanation (plain English, non-technical)
- Fix Recommendations (numbered list of concrete steps)
- Prevention Tips
- Severity: Low / Medium / High / Critical
Be specific, practical, and empathetic.`;

  const userPrompt = `Analyze this failed DeFi transaction:

## Transaction
- Hash: ${tx.hash}
- Network: ${tx.network}
- From: ${tx.from}
- To: ${tx.to}
- Contract: ${tx.contractName}
- Function: ${tx.functionName}
- Value: ${tx.value} ETH

## Gas
- Used: ${tx.gasUsed} | Limit: ${tx.gasLimit} | Price: ${tx.gasPrice}

## Error
- Raw Error: ${tx.error}
- Revert Reason: ${tx.revertReason}
- Input Data: ${tx.inputData}

## Context
${JSON.stringify(tx.additionalContext, null, 2)}

Provide a comprehensive diagnosis.`;

  // Turn 1: Diagnosis
  const history = [{ role: 'user', content: userPrompt }];
  const r1 = await callClaude(system, history, apiKey);
  history.push({ role: 'assistant', content: r1 });

  // Turn 2: Code fix
  history.push({ role: 'user', content: `Based on your diagnosis, provide:
1. A specific code snippet or parameter fix (if applicable)
2. Exact values/settings to change
3. A checklist before retrying the transaction
Format code in markdown code blocks.` });
  const r2 = await callClaude(system, history, apiKey);
  history.push({ role: 'assistant', content: r2 });

  // Turn 3: Risk assessment
  history.push({ role: 'user', content: `Finally:
1. Were any ETH/tokens lost?
2. Any security concerns?
3. Confidence level of diagnosis (High/Medium/Low) and why?` });
  const r3 = await callClaude(system, history, apiKey);

  return { diagnosis: r1, codeFix: r2, riskAssessment: r3 };
}

async function callClaude(system, messages, apiKey) {
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-opus-4-6',
      max_tokens: 2048,
      system,
      messages
    })
  });
  if (!resp.ok) {
    const err = await resp.json().catch(()=>({error:{message:resp.statusText}}));
    throw new Error(err.error?.message || `API error ${resp.status}`);
  }
  const data = await resp.json();
  return data.content[0].text;
}

// â”€â”€ Batch logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addToBatch() {
  const error = document.getElementById('b-error').value.trim();
  if (!error) { showToast('Error message required', true); return; }
  const item = {
    error,
    revertReason: document.getElementById('b-revert').value.trim(),
    contractName: document.getElementById('b-contract').value.trim() || 'Unknown',
    functionName: document.getElementById('b-function').value.trim() || 'Unknown',
    hash: '0x' + Math.random().toString(16).slice(2,12) + '...',
  };
  batchQueue.push(item);
  renderBatchQueue();
  ['b-error','b-revert','b-contract','b-function'].forEach(id => document.getElementById(id).value = '');
  showToast(`Added to batch (${batchQueue.length} items)`);
}

function loadBatchDemo() {
  batchQueue = Object.values(DEMOS).slice(0,4).map(d => ({
    hash: d.hash,
    error: d.error,
    revertReason: d.revert,
    contractName: d.contract,
    functionName: d.function,
  }));
  renderBatchQueue();
  showToast('Demo batch loaded (4 transactions)');
}

function removeBatchItem(i) {
  batchQueue.splice(i, 1);
  renderBatchQueue();
}

function clearBatch() {
  batchQueue = [];
  renderBatchQueue();
  document.getElementById('batchResults').style.display = 'none';
}

function renderBatchQueue() {
  const section = document.getElementById('batchQueueSection');
  const list = document.getElementById('batchList');
  const count = document.getElementById('batchCount');
  count.textContent = batchQueue.length;
  if (!batchQueue.length) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  list.innerHTML = batchQueue.map((item, i) => {
    const cat = classifyLocally(item.error, item.revertReason || '');
    const [bClass, bLabel] = getBadgeClass(cat);
    return `<div class="batch-row">
      <span class="batch-index">${i+1}</span>
      <span class="batch-hash">${item.contractName} â†’ ${item.functionName} (${item.error})</span>
      <span class="result-badge ${bClass} batch-cat">${bLabel}</span>
      <button class="batch-remove" onclick="removeBatchItem(${i})">Ã—</button>
    </div>`;
  }).join('');
}

async function runBatch() {
  if (!batchQueue.length) return;
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { showToast('Please enter your Anthropic API key', true); return; }

  const btn = document.getElementById('batchBtn');
  btn.disabled = true; btn.classList.add('loading');

  const results = [];
  const categoryCounts = {};

  for (let i = 0; i < batchQueue.length; i++) {
    const tx = batchQueue[i];
    showToast(`Analyzing ${i+1}/${batchQueue.length}â€¦`);
    try {
      const r = await diagnoseWithClaude(tx, apiKey);
      const cat = classifyLocally(tx.error, tx.revertReason || '');
      categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
      results.push({ success: true, tx, ...r, category: cat });
    } catch(e) {
      results.push({ success: false, tx, error: e.message });
    }
  }

  // Summary cards
  const cards = document.getElementById('batchSummaryCards');
  cards.innerHTML = `
    <div class="scard"><div class="scard-num">${results.length}</div><div class="scard-label">Total</div></div>
    <div class="scard"><div class="scard-num" style="color:var(--accent3)">${results.filter(r=>r.success).length}</div><div class="scard-label">Analyzed</div></div>
    <div class="scard"><div class="scard-num" style="color:var(--accent2)">${results.filter(r=>!r.success).length}</div><div class="scard-label">Failed</div></div>
    <div class="scard"><div class="scard-num">${Object.keys(categoryCounts).length}</div><div class="scard-label">Categories</div></div>
  `;

  // Result list
  const list = document.getElementById('batchResultsList');
  list.innerHTML = results.map((r, i) => {
    const [bClass, bLabel] = getBadgeClass(r.category || '');
    if (!r.success) return `<div class="section" style="border-color:var(--accent2)">
      <div class="section-title" style="color:var(--accent2)">[${i+1}] Error</div>
      <div style="font-size:11px;color:var(--accent2)">${r.error}</div>
    </div>`;
    return `<details class="section" style="margin-bottom:12px">
      <summary style="cursor:pointer;list-style:none;display:flex;align-items:center;gap:12px">
        <span style="color:var(--text-dim);font-size:11px">[${i+1}]</span>
        <span style="font-size:12px">${r.tx.contractName} â†’ ${r.tx.functionName}</span>
        <span class="result-badge ${bClass}" style="margin-left:auto">${bLabel}</span>
      </summary>
      <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:16px">
        <div class="ai-output">${renderMarkdown(r.diagnosis)}</div>
      </div>
    </details>`;
  }).join('');

  document.getElementById('batchResults').style.display = 'block';
  document.getElementById('batchResults').scrollIntoView({ behavior: 'smooth' });
  btn.disabled = false; btn.classList.remove('loading');
  showToast(`âœ“ Batch complete: ${results.filter(r=>r.success).length}/${results.length} analyzed`);
}

// â”€â”€ Toast notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg, isError = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show' + (isError ? ' error' : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.className = ''; }, 3200);
}
</script>
</body>
</html>
